---
import Layout from "../_layout.astro";
import { db } from "@/db";
import { postsTable, sessionsTable } from "@/schema";
import { usersTable } from "@/schema";
import { eq, and, gt, ne, sql } from "drizzle-orm";
import { AdminNavigation } from "@/components/AdminNavigation";
import Editor from "@/components/Editor";

const sessionToken = Astro.cookies.get("sessionCookie")?.value;

if (!sessionToken) {
  return new Response(null, {
    status: 302,
    headers: { Location: "/login" },
  });
}

const now = new Date();
const [session] = await db
  .select()
  .from(sessionsTable)
  .where(
    and(eq(sessionsTable.token, sessionToken), gt(sessionsTable.expiresAt, now))
  );

if (!session) {
  return new Response(null, {
    status: 302,
    headers: { Location: "/login" },
  });
}

// Fetch the user
const [user] = await db
  .select()
  .from(usersTable)
  .where(eq(usersTable.id, session.userId));

// Now fetch the "Your Posts"
const yourPostsRaw = await db
  .select()
  .from(postsTable)
  .where(eq(postsTable.author, user.id));
---

<Layout>
  <AdminNavigation client:load />

  <!-- Outer Container -->
  <div class="min-h-screen bg-gradient-to-r from-pink-50 to-pink-100">
    <div
      class="max-w-5xl mx-auto p-4 flex flex-col justify-start items-center space-y-6"
    >
      <h1 class="text-2xl font-semibold text-pink-700 text-center">
        Create a New Post
      </h1>

      <!-- Editor Wrapper -->
      <div class="bg-white shadow rounded-md p-6 w-full">
        <Editor user={user} client:only="react" />
      </div>
    </div>
  </div>
</Layout>
