---
import type { GetStaticPaths } from "astro";
import {
  listFileIdsInDriveFolder,
  getHtmlForDriveDoc,
} from "@/lib/google_drive";
import { parseGoogleDocHtml } from "@/lib/google_doc_html_parser";
import { CONFIG } from "@/app_config";
import Layout from "../../_layout.astro";
import { getPostById } from "@/lib/utils";
import { sessionsTable } from "@/schema";
import { eq, and, gt } from "drizzle-orm";
import { db } from "@/db";
import { AdminNavigation } from "@/components/AdminNavigation";
const sessionToken = Astro.cookies.get("sessionCookie")?.value;

if (!sessionToken) {
  return new Response(null, {
    status: 302,
    headers: { Location: "/login" },
  });
}

// current date to make sure session in db hasn't expired
const now = new Date();
const [session] = await db
  .select()
  .from(sessionsTable)
  .where(
    and(eq(sessionsTable.token, sessionToken), gt(sessionsTable.expiresAt, now))
  );

// If no valid session, redirect
if (!session) {
  return new Response(null, {
    status: 302,
    headers: { Location: "/login" },
  });
}

const { docId } = Astro.params;

if (!docId) {
  return redirect("/admin");
}

const post = await getPostById(Number(docId));

if (!post) {
  return redirect("/admin");
}

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const updatedData = {
    title: formData.get("title"),
    content: formData.get("content"),
    // Add other fields as necessary
  };

  // Update the post

  // Redirect after successful update
  return redirect("/admin");
}
---

<Layout>
  <AdminNavigation client:load />
  <div
    class="w-full flex flex-col justify-center items-center text-center bg-blue-background"
  >
    <div
      class="w-full min-h-screen text-black p-4 flex flex-col justify-start items-center max-w-5xl space-y-10"
    >
      <form method="POST" class="space-y-4">
        <div class="flex flex-col">
          <label class="text-white mb-2"> Title </label>
          <input
            id="title"
            type="text"
            class="border border-blue-foreground text-white bg-blue-background p-2 rounded-xl"
            value={post.title}
          />
        </div>

        <div class="flex flex-col">
          <label class="text-white mb-2"> Read time </label>
          <div class="flex flex-row justify-center items-center">
            <input
              id="readTime"
              type="number"
              class="border border-blue-foreground text-white bg-blue-background p-2 rounded-xl"
              value={post.readTime ?? 0}
            />
            <p class="text-yellow-bright">mins</p>
          </div>
        </div>

        <div class="flex flex-col">
          <label class="text-white mb-2"> Labels (separated by comma) </label>
          <input
            id="labels"
            type="text"
            class="border border-blue-foreground text-white bg-blue-background p-2 rounded-xl"
            value={post.tags ?? ""}
          />
        </div>

        <div class="flex flex-col">
          <label class="text-white mb-2"> Author </label>
          <input
            id="author"
            type="text"
            class="border border-blue-foreground text-white bg-blue-background p-2 rounded-xl"
            value={post.author}
          />
        </div>

        <div class="w-full flex items-center justify-center">
          <button
            type="submit"
            class="mt-4 rounded-full bg-yellow-bright border-8 border-yellow-medium text-blue-background font-bold px-12 py-2"
          >
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</Layout>
